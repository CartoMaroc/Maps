<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üó∫Ô∏è Discover Rabat - Tourist Map</title>
  <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', 'Cairo', sans-serif; overflow: hidden; }
    #map { width: 100%; height: 100vh; }
    .app-header { position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 20px; z-index: 2000; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; }
    .app-title { color: white; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .app-title .icon { font-size: 28px; animation: bounce 2s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .search-container { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); z-index: 1500; width: 90%; max-width: 400px; }
    .search-box { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 25px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); display: flex; align-items: center; padding: 8px 15px; gap: 10px; }
    .search-box input { flex: 1; border: none; outline: none; padding: 8px; font-size: 14px; background: transparent; font-family: 'Poppins', 'Cairo', sans-serif; }
    .search-box button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; }
    .search-box button:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5); }
    .control-buttons { position: absolute; right: 15px; top: 150px; display: flex; flex-direction: column; gap: 12px; z-index: 1500; }
    .control-btn { width: 50px; height: 50px; border-radius: 50%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
    .control-btn:hover { transform: scale(1.1); box-shadow: 0 6px 25px rgba(0,0,0,0.3); }
    .control-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .legend-container { position: absolute; bottom: 80px; left: 15px; z-index: 1500; max-width: 320px; width: 90%; }
    .legend-toggle { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 15px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 6px 20px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; }
    .legend-toggle:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
    .legend { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 15px; margin-top: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); max-height: 400px; overflow-y: auto; display: none; }
    .legend.show { display: block; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .accordion-section { margin-bottom: 12px; }
    .accordion-header { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; color: #333; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
    .accordion-header:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: scale(1.02); }
    .accordion-header.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .accordion-content { display: none; padding: 10px; font-size: 13px; }
    .accordion-content.show { display: block; }
    .legend-item { padding: 8px; margin: 5px 0; background: rgba(240, 240, 240, 0.5); border-radius: 8px; display: flex; align-items: center; gap: 10px; }
    .legend-item label { display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1; }
    .legend-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .ol-popup { position: absolute; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px); border-radius: 20px; padding: 20px; min-width: 250px; max-width: 350px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 3px solid; border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) 1; max-height: 70vh; overflow-y: auto; }
    .popup-header { font-size: 18px; font-weight: 700; color: #667eea; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
    .popup-content table { width: 100%; font-size: 13px; line-height: 1.8; }
    .popup-content td { padding: 6px; border-bottom: 1px solid #f0f0f0; }
    .popup-content td:first-child { font-weight: 600; color: #555; width: 40%; }
    .popup-content td:last-child { color: #333; }
    .popup-list-item { padding: 10px 12px; margin: 5px 0; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
    .popup-list-item:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: translateX(-5px); }
    .app-footer { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; color: #667eea; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1500; display: flex; align-items: center; gap: 6px; }
    .legend::-webkit-scrollbar, .ol-popup::-webkit-scrollbar { width: 8px; }
    .legend::-webkit-scrollbar-track, .ol-popup::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .legend::-webkit-scrollbar-thumb, .ol-popup::-webkit-scrollbar-thumb { background: #667eea; border-radius: 10px; }
    @media (max-width: 768px) {
      .app-title { font-size: 16px; }
      .app-title .icon { font-size: 22px; }
      .search-container { top: 65px; width: 95%; }
      .control-buttons { right: 10px; top: 135px; }
      .control-btn { width: 45px; height: 45px; font-size: 20px; }
      .legend-container { bottom: 70px; left: 10px; max-width: 280px; }
      .legend { max-height: 300px; }
      .ol-popup { min-width: 200px; max-width: 90%; max-height: 60vh; }
    }
  </style>
</head>
<body>
  <div class="app-header">
    <div class="app-title"><span class="icon">üó∫Ô∏è</span><span>Discover Rabat</span></div>
  </div>
  <div class="search-container">
    <div class="search-box">
      <span>üîç</span>
      <input id="searchInput" type="text" placeholder="Search places, bus lines..." />
      <button id="searchBtn">Search</button>
    </div>
  </div>
  <div class="control-buttons">
    <button class="control-btn" id="locateBtn" title="My Location">üìç</button>
    <button class="control-btn" id="pinBtn" title="Add Pin">üìå</button>
  </div>
  <div class="legend-container">
    <div class="legend-toggle" id="legendToggle"><span>üóÇÔ∏è</span><span>Map Legend</span></div>
    <div class="legend" id="main-legend">
      <div class="accordion-section">
        <div class="accordion-header" data-target="types-content"><span>üèõÔ∏è</span><span>Tourist Places</span></div>
        <div class="accordion-content" id="types-content"></div>
      </div>
      <div class="accordion-section">
        <div class="accordion-header" data-target="lines-content"><span>üöå</span><span>Bus Lines</span></div>
        <div class="accordion-content" id="lines-content"></div>
      </div>
    </div>
  </div>
  <div class="app-footer"><span>üåç</span><span>¬© CartoMaroc 2025</span></div>
  <div id="map"></div>
  <div id="popup" class="ol-popup" style="display:none;"></div>

  <script>
    document.getElementById("legendToggle").addEventListener("click", () => {
      document.getElementById("main-legend").classList.toggle('show');
    });

    document.querySelectorAll(".accordion-header").forEach(h => {
      h.addEventListener("click", () => {
        const t = h.getAttribute("data-target");
        const c = document.getElementById(t);
        const a = h.classList.contains("active");
        document.querySelectorAll(".accordion-content").forEach(x => x.classList.remove('show'));
        document.querySelectorAll(".accordion-header").forEach(x => x.classList.remove("active"));
        if (!a) { h.classList.add("active"); c.classList.add('show'); }
      });
    });

    const map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
          })
        }),
        new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}'
          })
        })
      ],
      view: new ol.View({ center: ol.proj.fromLonLat([-6.83255, 34.020882]), zoom: 13 })
    });

    const touristSource = new ol.source.Vector({
      url: 'https://raw.githubusercontent.com/Ayoub-WebGis9/CartoMaroc/main/TouristRabat.geojson',
      format: new ol.format.GeoJSON()
    });

    const busSource = new ol.source.Vector({
      url: 'https://raw.githubusercontent.com/Ayoub-WebGis9/CartoMaroc/refs/heads/main/Line-Stad-Rabat.geojson',
      format: new ol.format.GeoJSON()
    });

    const typeStyles = {}, lineStyles = {};

    function getProp(f, keys) {
      for (const k of keys) {
        const v = f.get(k);
        if (v !== undefined && v !== null) return v;
      }
      return undefined;
    }

    const emojiMap = {
  'airport': '‚úàÔ∏è', 'a√©roport': '‚úàÔ∏è',
  'cultural': 'üèõÔ∏è', 'culturel': 'üèõÔ∏è', 'culture': 'üèõÔ∏è', 'musee': 'üèõÔ∏è', 'museum': 'üèõÔ∏è',
  'ecotourism': 'üå≥', '√©cotourisme': 'üå≥', 'eco': 'üå≥', 'nature': 'üå≥', 'jardin': 'üå≥', 'garden': 'üå≥', 'park': 'üå≥',
  'hotel': 'üè®', 'h√¥tel': 'üè®', 'hotels': 'üè®',
  'stade': 'üèüÔ∏è', 'stadium': 'üèüÔ∏è',
  'gare': 'üöâ'
};


    function getEmoji(type) {
      const lt = type.toLowerCase().trim();
      if (emojiMap[lt]) return emojiMap[lt];
      for (const [k, e] of Object.entries(emojiMap)) {
        if (lt.includes(k)) return e;
      }
      return 'üìç';
    }

    const touristLayer = new ol.layer.Vector({
      source: touristSource,
      style: f => new ol.style.Style({
        text: new ol.style.Text({
          text: getEmoji((getProp(f, ['TYPE', 'Type', 'type']) || '').trim()),
          font: '28px sans-serif',
          textAlign: 'center',
          textBaseline: 'middle'
        })
      })
    });
    map.addLayer(touristLayer);

    const busLayer = new ol.layer.Vector({
      source: busSource,
      style: f => {
        const l = (getProp(f, ['from_ar', 'Line', 'line']) || '').trim();
        return (l && lineStyles[l]) ? lineStyles[l].style : new ol.style.Style({
          stroke: new ol.style.Stroke({ color: '#888', width: 5 })
        });
      }
    });
    map.addLayer(busLayer);

    const visibleTypes = new Set();
    touristSource.on('change', () => {
      const feats = touristSource.getFeatures();
      if (feats.length === 0) return;
      const types = [...new Set(feats.map(f => (getProp(f, ['TYPE', 'Type', 'type']) || '').trim()).filter(Boolean))];
      if (Object.keys(typeStyles).length === 0) {
        types.sort().forEach((t, i) => {
          typeStyles[t] = { color: `hsl(${(i * 360) / types.length}, 70%, 45%)` };
        });
        buildTypeLegend(types);
      }
    });

    function buildTypeLegend(arr) {
      const c = document.getElementById('types-content');
      c.innerHTML = '';
      arr.forEach(type => {
        const emoji = getEmoji(type);
        const id = 'chk_type_' + type.replace(/\s+/g, '_');
        const div = document.createElement('div');
        div.className = 'legend-item';
        div.innerHTML = `<label><input type="checkbox" id="${id}" checked><span style="font-size:24px;">${emoji}</span><span style="font-weight:600;">${type}</span></label>`;
        c.appendChild(div);
        visibleTypes.add(type);
        document.getElementById(id).addEventListener('change', e => {
          if (e.target.checked) visibleTypes.add(type); else visibleTypes.delete(type);
          touristLayer.setStyle(f => {
            const t = (getProp(f, ['TYPE', 'Type', 'type']) || '').trim();
            if (!visibleTypes.has(t)) return null;
            return new ol.style.Style({
              text: new ol.style.Text({ text: getEmoji(t), font: '28px sans-serif', textAlign: 'center', textBaseline: 'middle' })
            });
          });
        });
      });
    }

    const visibleLines = new Set();
    busSource.on('change', () => {
      const feats = busSource.getFeatures();
      if (feats.length === 0) return;
      const lines = [...new Set(feats.map(f => (getProp(f, ['from_ar', 'Line', 'line']) || '').trim()).filter(Boolean))];
      if (Object.keys(lineStyles).length === 0) {
        lines.sort().forEach((l, i) => {
          const color = `hsl(${(i * 360) / lines.length}, 70%, 40%)`;
          lineStyles[l] = {
            style: new ol.style.Style({ stroke: new ol.style.Stroke({ color, width: 5, lineJoin: 'round', lineCap: 'round' }) }),
            color
          };
        });
        buildLineLegend(lines);
      }
    });

    function buildLineLegend(arr) {
      const c = document.getElementById('lines-content');
      c.innerHTML = '';
      arr.forEach(line => {
        const color = lineStyles[line].color;
        const id = 'chk_line_' + line.replace(/\s+/g, '_');
        const div = document.createElement('div');
        div.className = 'legend-item';
        div.innerHTML = `<label><input type="checkbox" id="${id}" checked><span style="display:inline-block;width:40px;height:6px;background:${color};border-radius:3px;"></span><span>${line}</span></label>`;
        c.appendChild(div);
        visibleLines.add(line);
        document.getElementById(id).addEventListener('change', e => {
          if (e.target.checked) visibleLines.add(line); else visibleLines.delete(line);
          busLayer.setStyle(f => {
            const l = (getProp(f, ['from_ar', 'Line', 'line']) || '').trim();
            return (l && lineStyles[l] && visibleLines.has(l)) ? lineStyles[l].style : null;
          });
        });
      });
    }

    const popupEl = document.getElementById('popup');
    const overlay = new ol.Overlay({ element: popupEl, autoPan: true, autoPanAnimation: { duration: 300 } });
    map.addOverlay(overlay);

    let selectedFeature = null;
    const highlightStyle = new ol.style.Style({ stroke: new ol.style.Stroke({ color: 'rgba(255, 215, 0, 0.9)', width: 8 }) });
    const originalStyles = new Map();

    function selectFeature(f) {
      if (selectedFeature) {
        selectedFeature.setStyle(originalStyles.get(selectedFeature) || null);
        selectedFeature = null;
      }
      if (!originalStyles.has(f)) originalStyles.set(f, f.getStyle());
      f.setStyle(highlightStyle);
      selectedFeature = f;
    }

    map.on('singleclick', evt => {
      overlay.setPosition(undefined);
      popupEl.style.display = 'none';
      const fps = [];
      map.forEachFeatureAtPixel(evt.pixel, (f, l) => {
        if (l === touristLayer || l === busLayer) fps.push({ feature: f, layer: l });
      });
      if (fps.length === 0) {
        if (selectedFeature) {
          selectedFeature.setStyle(originalStyles.get(selectedFeature) || null);
          selectedFeature = null;
        }
        return;
      }
      if (fps[0].layer === touristLayer) {
        const f = fps[0].feature;
        const props = f.getProperties();
        const type = props.TYPE || props.Type || props.type || '';
        const emoji = getEmoji(type);
        let html = `<div class="popup-header">${emoji} Tourist Info</div><div class="popup-content"><table>`;
        for (const k in props) {
          if (k !== 'geometry') html += `<tr><td>${k}</td><td>${props[k]}</td></tr>`;
        }
        html += '</table></div>';
        popupEl.innerHTML = html;
        popupEl.style.display = 'block';
        overlay.setPosition(evt.coordinate);
        return;
      }
      const busFs = fps.filter(x => x.layer === busLayer).map(x => x.feature);
      if (busFs.length === 1) {
        const f = busFs[0];
        const ln = f.get('from_ar') || f.get('Line') || 'Bus Line';
        selectFeature(f);
        popupEl.innerHTML = `<div class="popup-header">üöå ${ln}</div>`;
        popupEl.style.display = 'block';
        overlay.setPosition(evt.coordinate);
      } else if (busFs.length > 1) {
        let html = '<div class="popup-header">üöå Select Bus Line</div><div class="popup-content">';
        busFs.forEach((f, i) => {
          const ln = f.get('from_ar') || f.get('Line') || `Bus ${i + 1}`;
          html += `<div class="popup-list-item" onclick="selectBusFromPopup(${i})">üöå ${ln}</div>`;
        });
        html += '</div>';
        popupEl.innerHTML = html;
        popupEl.style.display = 'block';
        overlay.setPosition(evt.coordinate);
        window.selectBusFromPopup = function(idx) {
          selectFeature(busFs[idx]);
          popupEl.style.display = 'none';
          overlay.setPosition(undefined);
        };
      }
    });

    function search() {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      if (!q) { alert('‚ö†Ô∏è Please enter search text'); return; }
      const tFs = touristSource.getFeatures();
      for (const f of tFs) {
        const v = getProp(f, ['Name', 'NAME', 'name']);
        if (v && v.toLowerCase().includes(q)) {
          map.getView().animate({ center: f.getGeometry().getFirstCoordinate(), zoom: 17, duration: 1000 });
          return;
        }
      }
      const bFs = busSource.getFeatures();
      for (const f of bFs) {
        const v = getProp(f, ['from_ar', 'Line', 'line']);
        if (v && v.toLowerCase().includes(q)) {
          const g = f.getGeometry();
          let c = null;
          if (g.getType() === 'LineString') c = g.getFirstCoordinate();
          else if (g.getType() === 'MultiLineString') c = g.getLineString(0).getFirstCoordinate();
          else c = g.getClosestPoint(map.getView().getCenter());
          map.getView().animate({ center: c, zoom: 14, duration: 1000 });
          return;
        }
      }
      alert('‚ùå No results found');
    }

    document.getElementById('searchBtn').addEventListener('click', search);
    document.getElementById('searchInput').addEventListener('keyup', e => { if (e.key === 'Enter') search(); });

    const locLayer = new ol.layer.Vector({
      source: new ol.source.Vector(),
      style: new ol.style.Style({
        image: new ol.style.Circle({ radius: 10, fill: new ol.style.Fill({ color: 'red' }), stroke: new ol.style.Stroke({ color: 'white', width: 3 }) })
      })
    });
    map.addLayer(locLayer);

    document.getElementById('locateBtn').addEventListener('click', () => {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(pos => {
          const c = ol.proj.fromLonLat([pos.coords.longitude, pos.coords.latitude]);
          locLayer.getSource().clear();
          locLayer.getSource().addFeature(new ol.Feature(new ol.geom.Point(c)));
          map.getView().animate({ center: c, zoom: 15 });
        }, err => alert("Unable to get your position: " + err.message), { enableHighAccuracy: true, timeout: 10000 });
      } else alert("Geolocation not supported.");
    });

    const pinSource = new ol.source.Vector();
    const pinLayer = new ol.layer.Vector({
      source: pinSource,
      style: new ol.style.Style({
        image: new ol.style.Icon({ src: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', scale: 0.07, anchor: [0.5, 1] })
      })
    });
    map.addLayer(pinLayer);

    let pinActive = false;
    document.getElementById('pinBtn').addEventListener('click', () => {
      pinActive = !pinActive;
      document.getElementById('pinBtn').classList.toggle('active');
    });

    map.on('click', evt => {
      if (!pinActive) return;
      pinSource.clear();
      pinSource.addFeature(new ol.Feature(new ol.geom.Point(evt.coordinate)));
      pinActive = false;
      document.getElementById('pinBtn').classList.remove('active');
    });
  </script>
</body>
</html>
