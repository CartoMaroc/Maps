<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carte Interactive de Tanger - CartoMaroc</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.2.1/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.2.1/dist/ol.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #f5f5f5;
        }
        
        #map {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        /* ===== HEADER ===== */
        .app-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: bold;
        }

        .header-icon {
            font-size: 22px;
        }

        .menu-btn, .link-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 22px;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            text-decoration: none;
        }

        .menu-btn:active, .link-btn:active {
            transform: scale(0.9);
            background: rgba(255,255,255,0.3);
        }
        
        /* ===== LEGEND SIDEBAR ===== */
        .legend-container {
            position: fixed;
            top: 0;
            right: -340px;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .legend-container.open {
            right: 0;
        }

        .legend-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .close-legend-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .accordion-item {
            border-bottom: 1px solid #e0e0e0;
        }
        
        .accordion-header {
            padding: 14px 15px;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .accordion-header:active {
            background: #e9ecef;
        }
        
        .accordion-header::after {
            content: '‚ñº';
            font-size: 12px;
            transition: transform 0.3s;
        }
        
        .accordion-header.active::after {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 15px;
        }
        
        .accordion-content.active {
            max-height: 600px;
            padding: 12px 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            gap: 10px;
        }
        
        .legend-item input[type="checkbox"] {
            cursor: pointer;
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }
        
        .legend-color {
            width: 32px;
            height: 5px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        .legend-circle {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .legend-text {
            font-size: 14px;
            flex-grow: 1;
            color: #333;
        }
        
        /* ===== SEARCH BAR ===== */
        .search-container {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 999;
        }
        
        #searchInput {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 15px;
            outline: none;
            background: white;
        }

        #searchInput:focus {
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        /* ===== CONTROL BUTTONS ===== */
        .controls-container {
            position: absolute;
            bottom: 80px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 999;
        }
        
        .control-btn {
            background: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 22px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:active {
            transform: scale(0.9);
        }
        
        .control-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }
        
        /* ===== WATERMARK ===== */
        .watermark {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 13px;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        /* ===== POPUP ===== */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            padding: 0;
            border-radius: 12px;
            border: none;
            bottom: 12px;
            left: -50px;
            min-width: 260px;
            max-width: 320px;
            z-index: 1001;
            overflow: hidden;
        }
        
        .ol-popup:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 48px;
            border: 10px solid transparent;
            border-top-color: white;
        }
        
        .ol-popup-closer {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            z-index: 10;
            text-decoration: none;
            background: rgba(255,255,255,0.9);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .ol-popup-closer:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .popup-content {
            margin: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .popup-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 16px;
            padding: 15px 40px 15px 15px;
            margin: 0;
        }
        
        .popup-body {
            padding: 12px 15px;
        }
        
        .popup-row {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            gap: 10px;
        }

        .popup-row:last-child {
            border-bottom: none;
        }
        
        .popup-label {
            font-weight: 600;
            color: #667eea;
            min-width: 80px;
            font-size: 13px;
        }
        
        .popup-value {
            color: #333;
            flex: 1;
            font-size: 13px;
        }
        
        /* ===== MULTI SELECT POPUP ===== */
        .multi-select-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 12px;
            z-index: 1002;
            max-width: 280px;
            min-width: 200px;
        }
        
        .multi-select-title {
            font-weight: bold;
            font-size: 15px;
            color: #667eea;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        
        .multi-select-item {
            padding: 10px 12px;
            margin: 6px 0;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .multi-select-item:active {
            transform: scale(0.98);
            background: #667eea;
            color: white;
        }

        /* ===== OVERLAY ===== */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* ===== TOAST MESSAGE ===== */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 3000;
            display: none;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .toast.show {
            display: block;
            animation: fadeInOut 3s;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 768px) {
            .header-title span:last-child {
                display: none;
            }

            .search-container {
                width: 85%;
                max-width: none;
            }

            #searchInput {
                font-size: 14px;
                padding: 10px 16px;
            }

            .controls-container {
                bottom: 70px;
                left: 10px;
                gap: 10px;
            }

            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }

            .legend-container {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="app-header">
        <button class="menu-btn" onclick="toggleLegend()">‚ò∞</button>
        <div class="header-title">
            <span class="header-icon">üó∫Ô∏è</span>
            <span>Carte Interactive - Tanger</span>
        </div>
        <a href="https://www.cartomaroc.com" target="_blank" class="link-btn">üåê</a>
    </div>

    <!-- MAP -->
    <div id="map"></div>
    
    <!-- LEGEND SIDEBAR -->
    <div class="legend-container" id="legendContainer">
        <div class="legend-header">
            <span>üìã L√©gende</span>
            <button class="close-legend-btn" onclick="toggleLegend()">√ó</button>
        </div>
        
        <div class="accordion-item">
            <div class="accordion-header active" onclick="toggleAccordion(this)">
                <span>üèõÔ∏è Sites Touristiques</span>
            </div>
            <div class="accordion-content active" id="touristLegend"></div>
        </div>
        
        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion(this)">
                <span>üöè Arr√™ts de Bus</span>
            </div>
            <div class="accordion-content" id="stopBusLegend"></div>
        </div>
        
        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion(this)">
                <span>üöå Lignes de Bus</span>
            </div>
            <div class="accordion-content" id="lineBusLegend"></div>
        </div>
    </div>

    <!-- OVERLAY -->
    <div class="overlay" id="overlay" onclick="toggleLegend()"></div>
    
    <!-- SEARCH BAR -->
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="üîç Rechercher un site...">
    </div>
    
    <!-- CONTROL BUTTONS -->
    <div class="controls-container">
        <button class="control-btn" onclick="locateMe()" title="Me localiser">üìç</button>
        <button class="control-btn" id="markerBtn" onclick="toggleMarkerMode()" title="Placer un marqueur">üìå</button>
    </div>
    
    <!-- WATERMARK -->
    <div class="watermark">@CartoMaroc</div>

    <!-- TOAST MESSAGE -->
    <div class="toast" id="toast"></div>
    
    <!-- POPUP -->
    <div id="popup" class="ol-popup" style="display: none;">
        <a href="#" id="popup-closer" class="ol-popup-closer">√ó</a>
        <div id="popup-content" class="popup-content"></div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const busLineColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788',
            '#E63946', '#A8DADC', '#457B9D', '#F4A261', '#E76F51',
            '#2A9D8F', '#E9C46A', '#F4A460', '#264653', '#E07A5F'
        ];
        
        const stopBusColors = {
            'Primary': '#FF4444',
            'Secondary': '#4444FF',
            'primary': '#FF4444',
            'secondary': '#4444FF',
            'Primaire': '#FF4444',
            'Secondaire': '#4444FF',
            'Unknown': '#999999'
        };
        
        const touristColors = {
            'Agence Touristique': '#FF6B9D',
            'Cultural Tourism': '#C44569',
            'EcoTourism': '#2ECC71',
            'Stade': '#3498DB',
            'Gare': '#9B59B6',
            'Airoport': '#E74C3C',
            'Hotel': '#F39C12'
        };
        
        const touristEmojis = {
            'Agence Touristique': 'üè®',
            'Cultural Tourism': 'üè∞',
            'EcoTourism': 'üå≥',
            'Stade': 'üèüÔ∏è',
            'Gare': 'üöâ',
            'Airoport': '‚úàÔ∏è',
            'Hotel': 'üî∏'
        };

        // ===== TOAST FUNCTION =====
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // ===== MAP INITIALIZATION =====
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        maxZoom: 19
                    })
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([-5.8, 35.76]),
                zoom: 12
            })
        });
        
        // ===== POPUP SETUP =====
        const container = document.getElementById('popup');
        const content = document.getElementById('popup-content');
        const closer = document.getElementById('popup-closer');
        
        const overlay = new ol.Overlay({
            element: container,
            autoPan: {
                animation: {
                    duration: 250
                }
            }
        });
        map.addOverlay(overlay);
        
        closer.onclick = function() {
            overlay.setPosition(undefined);
            container.style.display = 'none';
            closer.blur();
            return false;
        };
        
        // ===== VARIABLES =====
        let busLineLayers = {};
        let stopBusLayers = {};
        let touristLayers = {};
        let markerMode = false;
        let markerLayer = null;
        let selectedFeatures = new ol.Collection();
        let multiSelectPopup = null;
        let geolocation = null;
        let geolocationLayer = null;
        
        // ===== GEOLOCATION SETUP (IMPROVED) =====
        function setupGeolocation() {
            geolocation = new ol.Geolocation({
                trackingOptions: {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                },
                projection: map.getView().getProjection()
            });

            const positionFeature = new ol.Feature();
            positionFeature.setStyle(new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 10,
                    fill: new ol.style.Fill({ color: '#3399CC' }),
                    stroke: new ol.style.Stroke({ color: '#fff', width: 3 })
                })
            }));

            const accuracyFeature = new ol.Feature();
            accuracyFeature.setStyle(new ol.style.Style({
                fill: new ol.style.Fill({ color: 'rgba(51, 153, 204, 0.2)' }),
                stroke: new ol.style.Stroke({ color: '#3399CC', width: 2 })
            }));

            geolocation.on('change:position', function() {
                const coordinates = geolocation.getPosition();
                if (coordinates) {
                    positionFeature.setGeometry(new ol.geom.Point(coordinates));
                    map.getView().animate({ 
                        center: coordinates, 
                        zoom: 16,
                        duration: 1000 
                    });
                    showToast('‚úÖ Localisation r√©ussie');
                }
            });

            geolocation.on('change:accuracyGeometry', function() {
                const geometry = geolocation.getAccuracyGeometry();
                if (geometry) {
                    accuracyFeature.setGeometry(geometry);
                }
            });

            geolocation.on('error', function(error) {
                let message = '';
                switch(error.code) {
                    case 1:
                        message = '‚ùå Acc√®s refus√©. V√©rifiez les param√®tres';
                        break;
                    case 2:
                        message = 'üì° Position indisponible';
                        break;
                    case 3:
                        message = '‚è±Ô∏è D√©lai d\'attente d√©pass√©';
                        break;
                    default:
                        message = '‚ùå Erreur de g√©olocalisation';
                }
                showToast(message);
                geolocation.setTracking(false);
            });

            geolocationLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [accuracyFeature, positionFeature]
                }),
                zIndex: 1000
            });
            
            map.addLayer(geolocationLayer);
        }

        setupGeolocation();
        
        // ===== SELECTION STYLE =====
        const selectedStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#FFFF00',
                width: 6
            }),
            image: new ol.style.Circle({
                radius: 12,
                fill: new ol.style.Fill({
                    color: 'rgba(255, 255, 0, 0.6)'
                }),
                stroke: new ol.style.Stroke({
                    color: '#FFFF00',
                    width: 3
                })
            })
        });
        
        const selectInteraction = new ol.interaction.Select({
            condition: ol.events.condition.click,
            features: selectedFeatures,
            style: selectedStyle
        });
        map.addInteraction(selectInteraction);
        
        // ===== LOAD DATA =====
        async function loadData() {
            try {
                showToast('‚è≥ Chargement des donn√©es...');
                
                const tourismResponse = await fetch('https://raw.githubusercontent.com/Ayoub-WebGis9/CartoMaroc/main/Tourism-Tanger.geojson');
                const tourismData = await tourismResponse.json();
                createTouristLayers(tourismData);
                
                const stopBusResponse = await fetch('https://raw.githubusercontent.com/Ayoub-WebGis9/CartoMaroc/main/StopBusTanger.geojson');
                const stopBusData = await stopBusResponse.json();
                createStopBusLayers(stopBusData);
                
                const lineBusResponse = await fetch('https://raw.githubusercontent.com/Ayoub-WebGis9/CartoMaroc/main/LineBusTanger1.geojson');
                const lineBusData = await lineBusResponse.json();
                createBusLineLayers(lineBusData);
                
                showToast('‚úÖ Donn√©es charg√©es');
                
            } catch (error) {
                console.error('Erreur:', error);
                showToast('‚ùå Erreur de chargement');
            }
        }
        
        // ===== CREATE TOURIST LAYERS =====
        function createTouristLayers(data) {
            const types = {};
            
            data.features.forEach(feature => {
                const type = feature.properties.TYPE || 'Autre';
                if (!types[type]) types[type] = [];
                types[type].push(feature);
            });
            
            const legendDiv = document.getElementById('touristLegend');
            
            Object.keys(types).forEach(type => {
                const features = types[type].map(f => 
                    new ol.format.GeoJSON().readFeature(f, {
                        featureProjection: 'EPSG:3857'
                    })
                );
                
                const vectorSource = new ol.source.Vector({ features });
                
                const layer = new ol.layer.Vector({
                    source: vectorSource,
                    style: createTouristStyle(type),
                    visible: true
                });
                
                layer.set('type', 'tourist');
                layer.set('name', type);
                map.addLayer(layer);
                touristLayers[type] = layer;
                
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <input type="checkbox" checked onchange="toggleLayer('tourist', '${type}', this.checked)">
                    <span style="font-size: 18px;">${touristEmojis[type] || 'üìç'}</span>
                    <span class="legend-text">${type}</span>
                `;
                legendDiv.appendChild(legendItem);
            });
        }
        
        // ===== CREATE TOURIST STYLE =====
        function createTouristStyle(type) {
            const emoji = touristEmojis[type] || 'üìç';
            const color = touristColors[type] || '#666666';
            
            return function(feature) {
                if (type === 'Stade' || type === 'Gare' || type === 'Airoport') {
                    return new ol.style.Style({
                        text: new ol.style.Text({
                            text: emoji,
                            font: '26px sans-serif',
                            offsetY: -12
                        })
                    });
                }
                
                return new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 9,
                        fill: new ol.style.Fill({ color: color }),
                        stroke: new ol.style.Stroke({
                            color: 'white',
                            width: 3
                        })
                    })
                });
            };
        }
        
        // ===== CREATE STOP BUS LAYERS =====
        function createStopBusLayers(data) {
            const types = {};
            
            data.features.forEach(feature => {
                const type = feature.properties.Type || feature.properties.type || feature.properties.TYPE || 'Unknown';
                if (!types[type]) types[type] = [];
                types[type].push(feature);
            });
            
            const legendDiv = document.getElementById('stopBusLegend');
            
            Object.keys(types).forEach(type => {
                const features = types[type].map(f => 
                    new ol.format.GeoJSON().readFeature(f, {
                        featureProjection: 'EPSG:3857'
                    })
                );
                
                const vectorSource = new ol.source.Vector({ features });
                const color = stopBusColors[type] || stopBusColors[type.toLowerCase()] || '#FF4444';
                
                const layer = new ol.layer.Vector({
                    source: vectorSource,
                    style: new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 7,
                            fill: new ol.style.Fill({ color: color }),
                            stroke: new ol.style.Stroke({
                                color: 'white',
                                width: 2
                            })
                        })
                    }),
                    visible: false
                });
                
                layer.set('type', 'stopBus');
                layer.set('name', type);
                map.addLayer(layer);
                stopBusLayers[type] = layer;
                
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <input type="checkbox" onchange="toggleLayer('stopBus', '${type}', this.checked)">
                    <span class="legend-circle" style="background: ${color};"></span>
                    <span class="legend-text">${type}</span>
                `;
                legendDiv.appendChild(legendItem);
            });
        }
        
        // ===== CREATE BUS LINE LAYERS =====
        function createBusLineLayers(data) {
            const lines = {};
            
            data.features.forEach(feature => {
                const number = feature.properties.Number || 'Inconnu';
                if (!lines[number]) lines[number] = [];
                lines[number].push(feature);
            });
            
            const legendDiv = document.getElementById('lineBusLegend');
            let colorIndex = 0;
            
            Object.keys(lines).sort().forEach(number => {
                const features = lines[number].map(f => 
                    new ol.format.GeoJSON().readFeature(f, {
                        featureProjection: 'EPSG:3857'
                    })
                );
                
                const vectorSource = new ol.source.Vector({ features });
                const color = busLineColors[colorIndex % busLineColors.length];
                colorIndex++;
                
                const layer = new ol.layer.Vector({
                    source: vectorSource,
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: color,
                            width: 4
                        })
                    }),
                    visible: false
                });
                
                layer.set('type', 'busLine');
                layer.set('name', number);
                map.addLayer(layer);
                busLineLayers[number] = layer;
                
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <input type="checkbox" onchange="toggleLayer('busLine', '${number}', this.checked)">
                    <span class="legend-color" style="background: ${color};"></span>
                    <span class="legend-text">Bus ${number}</span>
                `;
                legendDiv.appendChild(legendItem);
            });
        }
        
        // ===== TOGGLE LAYER =====
        function toggleLayer(category, name, visible) {
            let layer;
            if (category === 'tourist') layer = touristLayers[name];
            else if (category === 'stopBus') layer = stopBusLayers[name];
            else if (category === 'busLine') layer = busLineLayers[name];
            
            if (layer) layer.setVisible(visible);
        }
        
        // ===== TOGGLE ACCORDION =====
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const isActive = content.classList.contains('active');
            
            document.querySelectorAll('.accordion-content').forEach(c => {
                c.classList.remove('active');
            });
            document.querySelectorAll('.accordion-header').forEach(h => {
                h.classList.remove('active');
            });
            
            if (!isActive) {
                content.classList.add('active');
                header.classList.add('active');
            }
        }
        
        // ===== TOGGLE LEGEND =====
        function toggleLegend() {
            const legend = document.getElementById('legendContainer');
            const overlayEl = document.getElementById('overlay');
            legend.classList.toggle('open');
            overlayEl.classList.toggle('active');
        }
        
        // ===== SEARCH FUNCTIONALITY =====
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm.length < 2) {
                selectedFeatures.clear();
                overlay.setPosition(undefined);
                container.style.display = 'none';
                return;
            }
            
            const allLayers = [...Object.values(touristLayers), 
                              ...Object.values(stopBusLayers), 
                              ...Object.values(busLineLayers)];
            
            for (let layer of allLayers) {
                const source = layer.getSource();
                const features = source.getFeatures();
                
                for (let feature of features) {
                    const props = feature.getProperties();
                    const name = (props.name || props.Name || props.NAME || '').toLowerCase();
                    
                    if (name.includes(searchTerm)) {
                        const geometry = feature.getGeometry();
                        const coords = geometry.getType() === 'Point' ? 
                            geometry.getCoordinates() : 
                            geometry.getClosestPoint(map.getView().getCenter());
                        
                        selectedFeatures.clear();
                        selectedFeatures.push(feature);
                        showPopup(feature, coords);
                        
                        map.getView().animate({
                            center: coords,
                            zoom: 16,
                            duration: 500
                        });
                        return;
                    }
                }
            }
        });
        
        // ===== MAP CLICK EVENT =====
        map.on('click', function(evt) {
            if (multiSelectPopup) {
                document.body.removeChild(multiSelectPopup);
                multiSelectPopup = null;
            }
            
            if (markerMode) {
                addMarker(evt.coordinate);
                return;
            }
            
            const features = [];
            map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                features.push({feature: feature, layer: layer});
            });
            
            if (features.length === 0) {
                overlay.setPosition(undefined);
                container.style.display = 'none';
                selectedFeatures.clear();
                return;
            }
            
            const busLineFeatures = features.filter(f => {
                const props = f.feature.getProperties();
                return props.Number !== undefined;
            });
            
            if (busLineFeatures.length > 1) {
                showMultiSelectPopup(busLineFeatures, evt.pixel);
                return;
            }
            
            const feature = features[0].feature;
            const geometry = feature.getGeometry();
            let coords;
            
            if (geometry.getType() === 'Point') {
                coords = geometry.getCoordinates();
            } else if (geometry.getType() === 'LineString') {
                coords = geometry.getClosestPoint(evt.coordinate);
            } else if (geometry.getType() === 'MultiLineString') {
                const lines = geometry.getLineStrings();
                coords = lines[0].getClosestPoint(evt.coordinate);
            } else {
                coords = evt.coordinate;
            }
            
            showPopup(feature, coords);
        });
        
        // ===== SHOW MULTI SELECT POPUP =====
        function showMultiSelectPopup(features, pixel) {
            overlay.setPosition(undefined);
            container.style.display = 'none';
            
            multiSelectPopup = document.createElement('div');
            multiSelectPopup.className = 'multi-select-popup';
            multiSelectPopup.style.left = pixel[0] + 'px';
            multiSelectPopup.style.top = pixel[1] + 'px';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'multi-select-title';
            titleDiv.textContent = 'üöå Choisir une ligne';
            multiSelectPopup.appendChild(titleDiv);
            
            features.forEach(({feature, layer}) => {
                const props = feature.getProperties();
                const number = props.Number || 'Inconnu';
                const itemDiv = document.createElement('div');
                itemDiv.className = 'multi-select-item';
                itemDiv.innerHTML = `<span>üöå</span><span>Bus ${number}</span>`;
                itemDiv.onclick = function() {
                    document.body.removeChild(multiSelectPopup);
                    multiSelectPopup = null;
                    
                    const geometry = feature.getGeometry();
                    let coords;
                    if (geometry.getType() === 'LineString') {
                        coords = geometry.getClosestPoint(map.getView().getCenter());
                    } else if (geometry.getType() === 'MultiLineString') {
                        const lines = geometry.getLineStrings();
                        coords = lines[0].getClosestPoint(map.getView().getCenter());
                    } else {
                        coords = geometry.getCoordinates();
                    }
                    
                    selectedFeatures.clear();
                    selectedFeatures.push(feature);
                    showPopup(feature, coords);
                };
                multiSelectPopup.appendChild(itemDiv);
            });
            
            document.body.appendChild(multiSelectPopup);
        }
        
        // ===== SHOW POPUP =====
        function showPopup(feature, coordinate) {
            const props = feature.getProperties();
            const title = props.name || props.Name || props.NAME || 'Information';
            
            let html = `<div class="popup-title">${title}</div><div class="popup-body">`;
            
            for (let key in props) {
                if (key !== 'geometry' && props[key] != null && props[key] !== '' && 
                    key !== 'name' && key !== 'Name' && key !== 'NAME') {
                    html += `<div class="popup-row">
                        <span class="popup-label">${key}</span>
                        <span class="popup-value">${props[key]}</span>
                    </div>`;
                }
            }
            
            html += '</div>';
            content.innerHTML = html;
            container.style.display = 'block';
            overlay.setPosition(coordinate);
        }
        
        // ===== LOCATE ME =====
        function locateMe() {
            if (!geolocation) {
                showToast('‚ùå G√©olocalisation non disponible');
                return;
            }
            
            showToast('üîç Recherche de votre position...');
            geolocation.setTracking(true);
            
            setTimeout(() => {
                geolocation.setTracking(false);
            }, 5000);
        }
        
        // ===== TOGGLE MARKER MODE =====
        function toggleMarkerMode() {
            markerMode = !markerMode;
            const btn = document.getElementById('markerBtn');
            btn.classList.toggle('active', markerMode);
            
            if (markerMode) {
                map.getTargetElement().style.cursor = 'crosshair';
                showToast('üìå Cliquez sur la carte');
            } else {
                map.getTargetElement().style.cursor = '';
            }
        }
        
        // ===== ADD MARKER =====
        function addMarker(coordinate) {
            if (markerLayer) {
                map.removeLayer(markerLayer);
            }
            
            const marker = new ol.Feature({
                geometry: new ol.geom.Point(coordinate)
            });
            
            const vectorSource = new ol.source.Vector({
                features: [marker]
            });
            
            markerLayer = new ol.layer.Vector({
                source: vectorSource,
                style: new ol.style.Style({
                    text: new ol.style.Text({
                        text: 'üìå',
                        font: '32px sans-serif',
                        offsetY: -16
                    })
                })
            });
            
            map.addLayer(markerLayer);
            
            map.getView().animate({
                center: coordinate,
                zoom: 16,
                duration: 500
            });
            
            showToast('‚úÖ Marqueur ajout√©');
            
            if (markerMode) {
                toggleMarkerMode();
            }
        }
        
        // ===== LOAD DATA ON START =====
        loadData();
    </script>
</body>
</html>

