<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<title>Ù…Ù‚Ø·Ø¹ Ø¹Ø±Ø¶ÙŠ Ù„Ù„ØªØ¶Ø§Ø±ÙŠØ³ - CartoMaroc</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Draw -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
html,body {margin:0;height:100%;font-family:'Cairo',sans-serif;background:#f2f2f2;}
#map {height:50vh;width:100%;position:relative;}
#profileContainer {height:50vh;width:100%;background:#fff;padding:20px;box-sizing:border-box;}
#topBar {
  background:#fff;padding:6px 12px;
  display:flex;justify-content:space-between;align-items:center;
  box-shadow:0 1px 4px rgba(0,0,0,0.25);
}
.btn {
  background:#961748;color:#fff;border:none;border-radius:4px;
  padding:6px 10px;cursor:pointer;font-size:13px;margin-left:5px;
}
.small {font-size:12px;color:#444;}
#chartCanvas {max-height:calc(50vh - 40px);}
#info {margin-top:10px;font-size:13px;color:#666;}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
#infoPanel {
  position:absolute;
  bottom:20px;
  right:20px;
  background:#fff;
  border:5px solid #7B3FF2;
  border-radius:15px;
  padding:12px 15px;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
  z-index:1000;
  min-width:180px;
  font-family:'Cairo',sans-serif;
  transform: scale(0.8);
}
#infoPanel .panel-btn {
  background:#961748;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:6px 12px;
  cursor:pointer;
  font-size:12px;
  font-family:'Cairo',sans-serif;
  width:100%;
  margin:4px 0;
  font-weight:bold;
}
#infoPanel .panel-btn:hover {
  background:#7a1239;
}
#infoPanel .sampling-info {
  font-size:11px;
  color:#333;
  margin:6px 0 2px 0;
  text-align:center;
  font-weight:bold;
}
#infoPanel .sampling-select {
  width:100%;
  padding:5px;
  border:2px solid #7B3FF2;
  border-radius:6px;
  font-family:'Cairo',sans-serif;
  font-size:11px;
  font-weight:bold;
  text-align:center;
  margin:2px 0 6px 0;
  cursor:pointer;
}
#infoPanel .website-info {
  font-size:10px;
  color:#7B3FF2;
  margin-top:8px;
  text-align:center;
  border-top:2px solid #7B3FF2;
  padding-top:6px;
  font-size: 18px;
  font-family:'Cairo';
}
#infoPanel .website-link {
  color:#961748;
  text-decoration:none;
  font-weight:bold;
  font-size: 18px;
  font-family:'Cairo';
}
</style>
</head>
<body>

<div id="topBar">
  <div><b>ğŸ“Š Ù…Ù‚Ø·Ø¹ Ø¹Ø±Ø¶ÙŠ Ù„Ù„ØªØ¶Ø§Ø±ÙŠØ³</b> <span class="small">Ø§Ø±Ø³Ù… Ø®Ø·Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„Ø¹Ø±Ø¶ÙŠ</span></div>
</div>

<div id="map">
  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
  <div id="infoPanel">
    <button class="panel-btn" id="clearBtnPanel">ğŸ—‘ï¸ Clear</button>
    <div class="sampling-info">Sampling:</div>
    <select class="sampling-select" id="samplingSelect">
      <option value="200">200 m</option>
      <option value="100">100 m</option>
      <option value="50">50 m</option>
      <option value="20">20 m</option>
    </select>
    <button class="panel-btn" id="downloadPNGPanel">ğŸ“¥ PNG (HD)</button>
    <button class="panel-btn" id="downloadPNGNormalPanel">ğŸ“¥ PNG (Normal)</button>
    <button class="panel-btn" id="downloadCSVPanel">ğŸ“Š CSV</button>
    <button class="panel-btn" id="downloadGeoJSONPanel">ğŸŒ GeoJSON</button>
    <div class="website-info">
      Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø²ÙˆØ±ÙˆØ§ Ù…ÙˆÙ‚Ø¹Ù†Ø§<br>
      <a href="https://www.cartomaroc.com" target="_blank" class="website-link">www.cartomaroc.com</a>
    </div>
  </div>
</div>
<div id="profileContainer">
  <canvas id="chartCanvas"></canvas>
  <div id="info"></div>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø±ÙŠØ·Ø© Leaflet
var map = L.map('map').setView([31.7917, -7.0926], 8); // Ø§Ù„Ù…ØºØ±Ø¨
var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 19,
  attribution: 'Esri'
}).addTo(map);
var labels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 19
}).addTo(map);

// Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…
var drawnItems = new L.FeatureGroup().addTo(map);
var drawControl = new L.Control.Draw({
  draw: {
    polyline: { shapeOptions: { color: '#961748', weight: 3 } },
    polygon: false, rectangle: false, circle: false, marker: false, circlemarker: false
  },
  edit: { featureGroup: drawnItems, remove: true }
});
map.addControl(drawControl);

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let chart = null;
let currentProfileData = null;
let currentLayer = null;
let samplingDistance = 200;

// Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Haversine)
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
            Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// ØªÙˆÙ„ÙŠØ¯ Ù†Ù‚Ø§Ø· Ù…ØªØ³Ø§ÙˆÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·
function interpolatePoints(coords, samplingDist = 200) {
  const points = [];
  points.push(coords[0]);
  for (let i = 0; i < coords.length - 1; i++) {
    const [lon1, lat1] = coords[i];
    const [lon2, lat2] = coords[i + 1];
    const segmentDist = getDistance(lat1, lon1, lat2, lon2);
    const numPoints = Math.max(1, Math.floor(segmentDist / samplingDist));
    for (let j = 1; j <= numPoints; j++) {
      const t = j / numPoints;
      const lat = lat1 + (lat2 - lat1) * t;
      const lon = lon1 + (lon2 - lon1) * t;
      points.push([lon, lat]);
    }
  }
  return points;
}

// Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„Ø¹Ø±Ø¶ÙŠ
async function buildProfile(geojson) {
  document.getElementById('info').innerHTML = '<i>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø±ØªÙØ§Ø¹...</i>';
  const coords = geojson.geometry.coordinates;
  const interpolatedCoords = interpolatePoints(coords, samplingDistance);
  const locs = interpolatedCoords.map(c => ({ latitude: c[1], longitude: c[0] }));

  try {
    const response = await fetch("https://api.open-elevation.com/api/v1/lookup", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ locations: locs })
    });
    const data = await response.json();
    const elevations = data.results.map(r => r.elevation);

    const distances = [0];
    let totalDistance = 0;
    for (let i = 1; i < interpolatedCoords.length; i++) {
      const dist = getDistance(
        interpolatedCoords[i-1][1], interpolatedCoords[i-1][0],
        interpolatedCoords[i][1], interpolatedCoords[i][0]
      );
      totalDistance += dist;
      distances.push(totalDistance);
    }

    const distancesKm = distances.map(d => (d / 1000).toFixed(2));
    const minElev = Math.min(...elevations).toFixed(0);
    const maxElev = Math.max(...elevations).toFixed(0);
    const avgElev = (elevations.reduce((a, b) => a + b, 0) / elevations.length).toFixed(0);
    const totalDistKm = (totalDistance / 1000).toFixed(2);

    document.getElementById('info').innerHTML = `
      <b>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‚Ø·Ø¹:</b> 
      Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©: ${totalDistKm} ÙƒÙ… | 
      Ø£Ø¯Ù†Ù‰ Ø§Ø±ØªÙØ§Ø¹: ${minElev} Ù… | 
      Ø£Ø¹Ù„Ù‰ Ø§Ø±ØªÙØ§Ø¹: ${maxElev} Ù… | 
      Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹: ${avgElev} Ù…
    `;

    drawChart(distancesKm, elevations);
    currentProfileData = { distances: distancesKm, elevations, coords: interpolatedCoords };
  } catch (error) {
    document.getElementById('info').innerHTML = '<span style="color:red;">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</span>';
    console.error(error);
  }
}

// Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø·
function drawChart(distances, elevations) {
  const ctx = document.getElementById('chartCanvas').getContext('2d');
  if (chart) chart.destroy();

  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(150, 23, 72, 0.5)');
  gradient.addColorStop(1, 'rgba(150, 23, 72, 0.1)');

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: distances,
      datasets: [{
        label: 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ù…ØªØ±)',
        data: elevations, // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‡Ù†Ø§
        borderColor: '#961748',
        backgroundColor: gradient,
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: '#961748'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: { font: { family: 'Cairo', size: 12 } }
        },
        tooltip: {
          callbacks: {
            title: function(context) {
              return 'Ø§Ù„Ù…Ø³Ø§ÙØ©: ' + context[0].label + ' ÙƒÙ…';
            },
            label: function(context) {
              return 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹: ' + context.parsed.y.toFixed(0) + ' Ù…';
            }
          },
          titleFont: { family: 'Cairo' },
          bodyFont: { family: 'Cairo' }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)', font: { family: 'Cairo', size: 14 } },
          ticks: { font: { family: 'Cairo' } }
        },
        y: {
          title: { display: true, text: 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ù…ØªØ±)', font: { family: 'Cairo', size: 14 } },
          ticks: { font: { family: 'Cairo' } },
          beginAtZero: false
        }
      }
    }
  });
}


// Ø¹Ù†Ø¯ Ø±Ø³Ù… Ø®Ø· Ø¬Ø¯ÙŠØ¯
map.on(L.Draw.Event.CREATED, function(e) {
  drawnItems.clearLayers();
  drawnItems.addLayer(e.layer);
  currentLayer = e.layer;
  const geo = e.layer.toGeoJSON();
  buildProfile(geo);
});

// Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¹ÙŠÙ†Ø§Øª
document.getElementById('samplingSelect').onchange = function() {
  samplingDistance = parseInt(this.value);
  if (currentLayer) {
    const geo = currentLayer.toGeoJSON();
    buildProfile(geo);
  }
};

// Ø²Ø± Ø§Ù„Ù…Ø³Ø­
function clearAll() {
  drawnItems.clearLayers();
  if (chart) {
    chart.destroy();
    chart = null;
  }
  currentProfileData = null;
  currentLayer = null;
  document.getElementById('info').innerHTML = '';
}
document.getElementById('clearBtnPanel').onclick = clearAll;

// ØªÙ†Ø²ÙŠÙ„ PNG
function downloadPNG(scaleFactor = 2) {
  if (!chart) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±Ø³Ù… Ø®Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }

  const originalCanvas = document.getElementById('chartCanvas');
  const tempCanvas = document.createElement('canvas');
  const tempCtx = tempCanvas.getContext('2d');
  tempCanvas.width = originalCanvas.width * scaleFactor;
  tempCanvas.height = originalCanvas.height * scaleFactor;

  const gradient = tempCtx.createLinearGradient(0, 0, 0, tempCanvas.height);
  gradient.addColorStop(0, 'rgba(150, 23, 72, 0.5)');
  gradient.addColorStop(1, 'rgba(150, 23, 72, 0.1)');

  const tempChart = new Chart(tempCtx, {
    type: 'line',
    data: {
      labels: chart.data.labels,
      datasets: [{
        label: 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ù…ØªØ±)',
        data: chart.data.datasets[0].data, // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‡Ù†Ø§
        borderColor: '#961748',
        backgroundColor: gradient,
        borderWidth: 2 * scaleFactor,
        fill: true,
        tension: 0.3,
        pointRadius: 0
      }]
    },
    options: {
      responsive: false,
      animation: false,
      devicePixelRatio: scaleFactor,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: { font: { family: 'Cairo', size: 12 * scaleFactor } }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)', font: { family: 'Cairo', size: 14 * scaleFactor } },
          ticks: { font: { family: 'Cairo', size: 11 * scaleFactor } }
        },
        y: {
          title: { display: true, text: 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ù…ØªØ±)', font: { family: 'Cairo', size: 14 * scaleFactor } },
          ticks: { font: { family: 'Cairo', size: 11 * scaleFactor } },
          beginAtZero: false
        }
      }
    }
  });

  setTimeout(() => {
    const dataURL = tempCanvas.toDataURL('image/png', 1.0);
    const link = document.createElement('a');
    link.download = `terrain-profile-${scaleFactor === 1 ? 'normal' : 'hd'}.png`;
    link.href = dataURL;
    link.click();
    tempChart.destroy();
  }, 1000);
}
// ØªÙ†Ø²ÙŠÙ„ CSV
function downloadCSV() {
  if (!currentProfileData) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±Ø³Ù… Ø®Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  let csv = 'Distance (km),Elevation (m),Latitude,Longitude\n';
  for (let i = 0; i < currentProfileData.distances.length; i++) {
    csv += `${currentProfileData.distances[i]},${currentProfileData.elevations[i].toFixed(2)},${currentProfileData.coords[i][1]},${currentProfileData.coords[i][0]}\n`;
  }
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'terrain-profile.csv';
  link.click();
}
document.getElementById('downloadCSVPanel').onclick = downloadCSV;

// âœ… ØªÙ†Ø²ÙŠÙ„ GeoJSON
function downloadGeoJSON() {
  if (!currentLayer) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±Ø³Ù… Ø®Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  const geojsonData = currentLayer.toGeoJSON();
  const jsonString = JSON.stringify(geojsonData, null, 2);
  const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'CartoMaroc-Line.geojson';
  link.click();
}
document.getElementById('downloadGeoJSONPanel').onclick = downloadGeoJSON;
  // âœ… Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
document.getElementById('downloadPNGPanel').onclick = function() {
  downloadPNG(2); // Ù†Ø³Ø®Ø© HD
};
document.getElementById('downloadPNGNormalPanel').onclick = function() {
  downloadPNG(1); // Ù†Ø³Ø®Ø© Ø¹Ø§Ø¯ÙŠØ©
};


</script>
</body>
</html>
